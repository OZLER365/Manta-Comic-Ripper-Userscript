

    // ==UserScript==
    // @name         Manta.net Chapter Downloader (Individual Files)
    // @namespace    http://tampermonkey.net/
    // @version      1.3
    // @description  Downloads chapter images individually on Manta.net (EN/ES/FR) in proper order.
    // @author       ozler365
    // @license      MIT
    // @match        https://manta.net/en/*
    // @match        https://manta.net/es/*
    // @match        https://manta.net/fr/*
    // @grant        GM_xmlhttpRequest
    // @grant        GM_download
    // @run-at       document-start
    // ==/UserScript==
     
    (function() {
        'use strict';
     
        let capturedChapterData = null;
        let downloadBtn = null;
        let isDownloading = false;
     
        // --- Extract Episode ID from URL ---
        function getEpisodeIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('episodeId');
        }
     
        // --- Data Interception ---
     
        // Helper to find 'cutImages' recursively in the JSON structure
        function findCutImagesAndTitle(obj, url) {
            if (!obj || typeof obj !== 'object') return null;
     
            // Check if URL contains episode ID to confirm it's the right request
            const episodeId = getEpisodeIdFromUrl();
            if (episodeId && url && !url.includes(episodeId)) {
                return null;
            }
     
            // Navigate through data structure: response -> data -> cutImages
            let searchObj = obj;
            if (obj.data) {
                searchObj = obj.data;
            }
     
            // Check if this object has cutImages array
            if (searchObj.cutImages && Array.isArray(searchObj.cutImages)) {
                // Sort by ord (page order) to ensure correct sequence
                const sortedImages = [...searchObj.cutImages].sort((a, b) => {
                    return (a.ord || 0) - (b.ord || 0);
                });
     
                return {
                    images: sortedImages,
                    title: searchObj.title || document.title,
                    episodeId: episodeId
                };
            }
     
            return null;
        }
     
        // Hook into XMLHttpRequest to catch the API response
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
            this.addEventListener('load', function() {
                try {
                    const contentType = this.getResponseHeader('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const res = JSON.parse(this.responseText);
                        const found = findCutImagesAndTitle(res, url);
     
                        if (found && found.images.length > 0) {
                            capturedChapterData = found;
                            console.log('[Manta Downloader] Chapter data captured via XHR:', found);
                            console.log(`[Manta Downloader] Found ${found.images.length} images`);
                            updateButtonState();
                        }
                    }
                } catch (e) {
                    // Ignore parsing errors
                }
            });
     
            originalOpen.apply(this, arguments);
        };
     
        // Hook into Fetch API
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            const response = await originalFetch(...args);
     
            try {
                const url = typeof args[0] === 'string' ? args[0] : args[0].url;
                const clone = response.clone();
                const contentType = clone.headers.get('content-type');
     
                if (contentType && contentType.includes('application/json')) {
                    clone.json().then(data => {
                        const found = findCutImagesAndTitle(data, url);
     
                        if (found && found.images.length > 0) {
                            capturedChapterData = found;
                            console.log('[Manta Downloader] Chapter data captured via Fetch:', found);
                            console.log(`[Manta Downloader] Found ${found.images.length} images`);
                            updateButtonState();
                        }
                    }).catch(() => {});
                }
            } catch (e) {}
     
            return response;
        };
     
        // --- UI Construction ---
     
        function createButton() {
            if (document.getElementById('manta-dl-btn')) return;
     
            downloadBtn = document.createElement('button');
            downloadBtn.id = 'manta-dl-btn';
            downloadBtn.innerText = 'Download Chapter';
            downloadBtn.style.position = 'fixed';
            downloadBtn.style.bottom = '20px';
            downloadBtn.style.right = '20px';
            downloadBtn.style.zIndex = '9999';
            downloadBtn.style.padding = '10px 20px';
            downloadBtn.style.backgroundColor = '#5c5c5c';
            downloadBtn.style.color = '#ffffff';
            downloadBtn.style.border = 'none';
            downloadBtn.style.borderRadius = '5px';
            downloadBtn.style.cursor = 'not-allowed';
            downloadBtn.style.fontWeight = 'bold';
            downloadBtn.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            downloadBtn.disabled = true;
     
            downloadBtn.onclick = startDownload;
     
            document.body.appendChild(downloadBtn);
        }
     
        function updateButtonState() {
            if (!downloadBtn) createButton();
     
            if (capturedChapterData && !isDownloading) {
                downloadBtn.style.backgroundColor = '#6200ea';
                downloadBtn.style.cursor = 'pointer';
                const title = capturedChapterData.title || 'Chapter';
                const count = capturedChapterData.images.length;
                downloadBtn.innerText = `Download: ${title} (${count} pages)`;
                downloadBtn.disabled = false;
            }
        }
     
        // --- Download Logic ---
     
        function startDownload() {
            if (!capturedChapterData || isDownloading) {
                return;
            }
     
            isDownloading = true;
            const images = capturedChapterData.images;
     
            // Use document title or chapter title for folder name
            const folderName = sanitizeFilename(document.title || capturedChapterData.title || 'Chapter').trim();
     
            downloadBtn.innerText = `Downloading 0/${images.length}...`;
            downloadBtn.disabled = true;
            downloadBtn.style.backgroundColor = '#ff6600';
     
            let completed = 0;
            let failed = 0;
     
            console.log(`[Manta Downloader] Starting download of ${images.length} images into folder: ${folderName}`);
     
            // Download images sequentially to avoid overwhelming the browser
            let currentIndex = 0;
     
            function downloadNext() {
                if (currentIndex >= images.length) {
                    // All done
                    isDownloading = false;
                    downloadBtn.style.backgroundColor = '#00cc00';
                    downloadBtn.innerText = `âœ“ Downloaded ${completed}/${images.length}${failed > 0 ? ` (${failed} failed)` : ''}`;
                    downloadBtn.disabled = false;
     
                    setTimeout(() => {
                        updateButtonState();
                    }, 3000);
     
                    console.log(`[Manta Downloader] Download complete! ${completed} succeeded, ${failed} failed`);
                    return;
                }
     
                const imgData = images[currentIndex];
                const url = imgData.downloadUrl;
     
                if (!url) {
                    console.warn('[Manta Downloader] No downloadUrl for image:', imgData);
                    failed++;
                    currentIndex++;
                    downloadNext();
                    return;
                }
     
                const ext = url.split('.').pop().split('?')[0] || 'jpg';
                const pageNum = imgData.ord || (currentIndex + 1);
                const filename = `${String(pageNum).padStart(3, '0')}.${ext}`;
                const fullPath = `${folderName}/${filename}`;
     
                console.log(`[Manta Downloader] Downloading ${currentIndex + 1}/${images.length}: ${filename}`);
     
                GM_download({
                    url: url,
                    name: fullPath,
                    onload: function() {
                        completed++;
                        currentIndex++;
                        downloadBtn.innerText = `Downloading ${currentIndex}/${images.length}...`;
     
                        // Small delay between downloads to be nice to the server
                        setTimeout(downloadNext, 100);
                    },
                    onerror: function(error) {
                        console.error('[Manta Downloader] Failed to download:', filename, error);
                        failed++;
                        currentIndex++;
                        downloadBtn.innerText = `Downloading ${currentIndex}/${images.length}...`;
     
                        setTimeout(downloadNext, 100);
                    },
                    ontimeout: function() {
                        console.error('[Manta Downloader] Timeout:', filename);
                        failed++;
                        currentIndex++;
                        downloadBtn.innerText = `Downloading ${currentIndex}/${images.length}...`;
     
                        setTimeout(downloadNext, 100);
                    }
                });
            }
     
            // Start the download chain
            downloadNext();
        }
     
        function sanitizeFilename(name) {
            // Remove invalid filename characters
            return name.replace(/[<>:"/\\|?*]/g, "").replace(/\s+/g, " ").trim().substring(0, 100);
        }
     
        // --- Initialize ---
     
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', createButton);
        } else {
            createButton();
        }
     
        window.addEventListener('load', createButton);
     
        // Monitor URL changes for SPA navigation
        let lastUrl = location.href;
        new MutationObserver(() => {
            const url = location.href;
            if (url !== lastUrl) {
                lastUrl = url;
                capturedChapterData = null;
                isDownloading = false;
                if (downloadBtn) {
                    downloadBtn.style.backgroundColor = '#5c5c5c';
                    downloadBtn.style.cursor = 'not-allowed';
                    downloadBtn.innerText = 'Download Chapter';
                    downloadBtn.disabled = true;
                }
            }
        }).observe(document, {subtree: true, childList: true});
     
    })();

